agents:
  reviewer:
    model: deepseek:deepseek-chat
    system_prompt: |
      You are a precise code reviewer. You analyze diffs and produce structured JSON output.
      Focus on: bugs, security issues, logic errors, bad patterns, and notable improvements.
      Be constructive. Reference specific files and line numbers.

      IMPORTANT: Your entire response must be valid JSON matching this schema:
      {
        "summary": "Brief overview of the changes and their quality",
        "issues": [
          {
            "severity": "error|warning|suggestion",
            "file": "path/to/file.ts",
            "line": 42,
            "message": "Description of the issue"
          }
        ],
        "highlights": [
          "Positive things worth mentioning"
        ]
      }

      Output ONLY the JSON object. No markdown, no code fences, no explanation.

context:
  provider: memory

setup:
  - shell: echo "$PR_NUMBER"
    as: pr_number

  - shell: echo "$GITHUB_REPOSITORY"
    as: repo

  # Read PR metadata directly (not to file)
  - shell: |
      gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" \
        --json title,body,baseRefName,headRefName,author,additions,deletions,changedFiles
    as: pr_info

  - shell: gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json files --jq '.files[].path'
    as: changed_files

  # Read the diff content directly (truncate to ~3000 lines to fit context)
  - shell: |
      if [ "$TRIGGER_TYPE" = "synchronize" ] && [ -n "$BEFORE_SHA" ] && [ -n "$AFTER_SHA" ]; then
        gh api "repos/$GITHUB_REPOSITORY/compare/$BEFORE_SHA...$AFTER_SHA" \
          -H "Accept: application/vnd.github.v3.diff" 2>/dev/null | head -3000
      else
        gh pr diff "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" 2>/dev/null | head -3000
      fi
    as: diff_content

  - shell: |
      if [ "$TRIGGER_TYPE" = "synchronize" ] && [ -n "$BEFORE_SHA" ] && [ -n "$AFTER_SHA" ]; then
        echo "incremental"
      else
        echo "initial"
      fi
    as: review_type

  # New commits list (incremental only, for context)
  - shell: |
      if [ "$TRIGGER_TYPE" = "synchronize" ] && [ -n "$BEFORE_SHA" ] && [ -n "$AFTER_SHA" ]; then
        gh api "repos/$GITHUB_REPOSITORY/compare/$BEFORE_SHA...$AFTER_SHA" \
          --jq '.commits[] | "- `\(.sha[0:7])` \(.commit.message | split("\n")[0])"' 2>/dev/null || echo ""
      else
        echo ""
      fi
    as: new_commits

kickoff: |
  @reviewer Review PR #${{ pr_number }} in ${{ repo }}.

  ## Review Type: ${{ review_type }}

  ## PR Metadata
  ```json
  ${{ pr_info }}
  ```

  ## Changed Files
  ```
  ${{ changed_files }}
  ```

  ## New Commits
  ```
  ${{ new_commits }}
  ```

  ## Diff
  ```diff
  ${{ diff_content }}
  ```

  ## Instructions

  Analyze the diff above and produce your review as a JSON object.

  Severity guide:
  - **error**: bugs, security issues, broken logic, data loss risks
  - **warning**: potential problems, bad patterns, missing edge cases
  - **suggestion**: style improvements, readability, minor optimizations

  Rules:
  - If no issues found, use `"issues": []`
  - Always include file paths and line numbers for issues
  - For incremental reviews, focus ONLY on the new changes in the diff
  - Be specific and actionable
  - Output ONLY valid JSON â€” no markdown, no code fences, no explanation
